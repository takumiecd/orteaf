# ベースマネージャ設計（ドラフト）

このドキュメントでは、制御ブロック、ペイロード格納、リース発行を
調整するベースラインのマネージャ概念を説明する。責務と拡張点を
定義するが、単一の具体実装を規定しない。

## 目的

- リースを発行する最小で再利用可能なマネージャコアを提供する。
- ペイロードのライフタイム管理をスロット再利用から分離する。
- 制御ブロックとペイロードで異なるプール型を選択可能にする。
- 各マネージャが、リースを要求ごとに生成するか、既存プールから
  再利用するかを決められるようにする。

## 中核概念

### マネージャ

マネージャは2つの異なるプールを所有する:

- **制御ブロックプール**: 制御ブロック（shared/weak/weak-shared）を格納する。
- **ペイロードプール**: 実際のペイロードオブジェクトを格納する。

マネージャは制御ブロックをペイロードスロットに結び付けて
リースを発行する。マネージャは単一の割り当て方針を強制せず、
選択されたプール型とポリシー特性に委譲する。

### 制御ブロック

制御ブロックは次を保持する:

- ペイロードハンドル（index + generation が有効な場合）。
- ペイロードポインタ。
- ペイロード解放用のプールポインタ。
- 参照カウント（強参照/弱参照、ブロック種別に応じて）。

制御ブロックは再利用可能。参照カウントがゼロになり、
ペイロードが解放されたら、制御ブロックはプールへ戻される。

### ペイロード

ペイロードのライフタイムは制御ブロックのライフタイムから分離される:

- ペイロードスロットは制御ブロックとは独立に再利用できる。
- ペイロードの生成と破棄はプール特性または
  カスタムの create/destroy 関数を通じて行う。

### リース

リースはマネージャが返す公開ハンドルで、次を持つ:

- 制御ブロックへの参照（ハンドル + ポインタ + generation）。
- 解放操作をディスパッチするためのマネージャポインタ（任意）。

リースの挙動はカテゴリ（shared, weak, weak-shared）で定義される。
マネージャがリースの生成/再利用方式を決定する。

## プール選択

マネージャは以下のプール型を選択できる必要がある:

- 制御ブロック: 通常は再利用のため `SlotPool`。
- ペイロード: `SlotPool`、`FixedSlotStore`、または専用プール。

選択はマネージャ実装が定めるポリシーである。プール API は
型をまたいで互換（initialize, acquire, release, get, emplace, destroy）
であるべきだ。

## リース生成ポリシー

マネージャは単一のリース生成戦略を前提としない。各具体マネージャは
次のいずれか（またはハイブリッド）を選ぶ:

- **要求ごとに生成**: acquire のたびにリースを構築する。
- **要求ごとに再利用**: リースプールやキャッシュから再利用する。

この選択はリースオブジェクトにのみ影響し、制御ブロックや
ペイロードプールには影響しない。ポリシーを入れ替えても
ペイロード/制御ブロックの意味論が変わらないよう、明確な API 境界を
提供すべきだ。

## 取得フロー（参照実装）

1. ペイロードプールからペイロードスロットを取得する。
2. 制御ブロックプールから制御ブロックスロットを取得する。
3. ペイロードのメタデータを制御ブロックに結び付ける。
4. 参照カウントを初期化する。
5. リースを生成または再利用し、返却する。

## 解放フロー（参照実装）

1. リースが制御ブロックへの強参照を減らす。
2. 強参照カウントがゼロになると、制御ブロックは
   ペイロードをプールへ返却しようとする。
3. 制御ブロックの参照カウントがゼロになったら、
   制御ブロックをプールへ返却する。
4. リースオブジェクトは破棄されるか、リースプールへ返却される
   （ポリシー次第）。

## 責務

マネージャの責務:

- 制御ブロックとペイロードのプール実装を選択する。
- プール API を使った acquire/release 振る舞いを定義する。
- リースの生成または再利用ポリシーを提供する。
- ペイロードと制御ブロックのプールがマネージャと同じ寿命を
  共有することを保証する（ペイロードプールは、それに束縛される
  制御ブロックより長生きする）。

プールの責務:

- スロットの格納と再利用を管理する。
- ハンドル/インデックス/generation による有効性を追跡する。
- ペイロードの生成/破棄フックを提供する。

制御ブロックの責務:

- 参照カウントを追跡する。
- アクセスと解放のためにペイロードメタデータを束縛する。
- 強参照カウントがゼロになった遷移でペイロード解放をトリガする。

## スレッドセーフティ

- 参照カウントはアトミック。
- プール操作とペイロード束縛はデフォルトでスレッドセーフではなく、
  必要に応じてマネージャが外部同期する必要がある。

## 未解決の問い

- リース生成は常に明示的にすべきか、暗黙的な再利用を許すべきか。
- マネージャ API をどの程度 `SlotPool` のメソッドに合わせるべきか。
- acquire がデフォルトで、ペイロード構築用の要求単位ファクトリを
  受け入れるべきかどうか。
