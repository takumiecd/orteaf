# テスト戦略ガイド (TDD 用)

ORTAF のコンポーネント開発ではテスト駆動開発 (TDD) を基本とし、以下の観点を順に検討する。各観点は必要に応じて選択的に採用し、過剰なテスト重複を避ける。

## チェックリストテンプレート
テストを作成するときは以下をコピーし、完了した項目からチェックを入れる。未実施の観点が一目で分かる。

- [ ] 条件テスト
- [ ] 等価クラス
- [ ] 境界条件
- [ ] パラメーターテスト
- [ ] 返し値アサート
- [ ] Getter / Setter
- [ ] 動作の順序
- [ ] ネガティブテスト
- [ ] バッファオーバーラン
- [ ] メモリオーナーシップ
- [ ] Null 入力
- [ ] パフォーマンステスト
- [ ] 回帰テスト（互換性用）

## 条件テスト
- `if` / `switch` 分岐をすべて通過させ、条件による挙動が期待通りかを確認する。
- 例: バックエンドが存在する場合としない場合でメモリ確保が成功/失敗するか。

## 等価クラス
- 入力を同じ結果をもたらすグループに分け、代表値をテストしてケース爆発を防ぐ。
- 例: Tensor のデータ型に対して、同じストレージ分類ごとに代表ケースを選ぶ。

## 境界条件
- 最小値・最大値、その近傍をテストして境界での不具合を検出する。
- 例: ゼロサイズ Tensor、最大サポート次元数、バッファの最終インデックスなど。

## パラメーターテスト
- 同じテストロジックに複数の入力パターンを流して、組み合わせを網羅する。
- 例: `Allocator` に対し、異なるアラインメント・サイズをパラメータ化する。

## 返し値アサート
- 戻り値や out-parameter が正しいかを直接アサートする基本テスト。
- 例: `RuntimeContext` の取得 API が期待したステータス値を返すか。

## Getter / Setter
- アクセサで値が正しく保存・取得されるかを単体で確認する。
- 例: `Module` の設定値が内部状態へ反映されているか。

## 動作の順序
- 一連の操作順序（初期化→実行→解放など）が意図どおりに成り立つかを検証する。
- 例: Runtime を初期化してから Tensor を生成し、最後に `RuntimeContext` を破棄するフロー。

## ネガティブテスト
- 無効な入力や環境で適切にエラーを返す/例外を投げるか確認する。
- 例: `nullptr` TensorImpl を渡してエラーが投げられるか。

## バッファオーバーラン
- 配列やバッファの境界外アクセスを検出するテスト。
- 例: 境界チェックを行うテストや、サニタイザ/アドレスサニタイザと併用して走らせる。

## メモリオーナーシップ
- 所有権の移動・解放が適切か、二重解放やダングリングポインタがないかを確認する。
- 例: `TensorImpl` が解放された後に参照が残っていないかを確認。

## Null 入力
- `nullptr` や空参照を渡した場合の安全性をチェックする。
- 例: `Module` に null サブモジュールを登録しようとした際の防御処理。

## パフォーマンステスト
- 性能要件を測定し、許容範囲内か評価する。
- 例: 大規模バッチでの推論速度、メモリ使用量の上限などを計測。

## 回帰テスト（互換性維持）
- 互換性維持のため、既存仕様を固定化するテスト。初期フェーズでは必須ではないが、仕様が確定した API や過去のバグに対しては追加する。

## ベースレイヤーの単体テスト指針
- `orteaf/internal/base` 配下の汎用ユーティリティ（例: `math_utils.h`, `strong_id.h`）は、上位レイヤーに依存しないよう `tests/internal/base` 直下で検証する。
- 典型パス
  - `tests/internal/base/math_utils_test.cpp`: `isPowerOfTwo` / `nextPowerOfTwo` の境界ケースや広範な連続値を網羅し、バックエンド実装に影響が出る前に回帰を検出する。
  - `tests/internal/base/strong_id_test.cpp`: `DeviceId`/`StreamId` など強い ID 型の比較・変換・`invalid()` ヘルパーを確認する。Runtime ディレクトリではなく base 直下に配置し、利用箇所と同じ責務の層で管理する。
- 「テスト配置が仕様と一致しているか」を PR チェックリストに含め、base 層のユーティリティであれば runtime/backend ではなく base ディレクトリに追加する。

---
- 新しいコンポーネントを作る際は、まず等価クラスと境界条件を決め、条件テストとネガティブテストで仕様を固める。
- その後、TDD のサイクル（Red → Green → Refactor）を回しながら必要な観点を追加していく。
- パフォーマンス測定や回帰テストはリリース準備や仕様凍結の段階で強化する。
