# Generate CUDA kernel registry implementation for ORTEAF.
# Required variables:
#   OUTPUT - destination .cpp file
#   KERNEL_RECORDS - serialized list (kernel_raw:kernel_norm:fmt:symbol_prefix:obj_file)

if(NOT DEFINED OUTPUT)
    message(FATAL_ERROR "OrteafKernelEmbedGenerate: OUTPUT not specified")
endif()
if(NOT DEFINED KERNEL_RECORDS)
    message(FATAL_ERROR "OrteafKernelEmbedGenerate: KERNEL_RECORDS not specified")
endif()

get_filename_component(_gen_dir "${OUTPUT}" DIRECTORY)
if(NOT IS_DIRECTORY "${_gen_dir}")
    file(MAKE_DIRECTORY "${_gen_dir}")
endif()

set(content "// Auto-generated by OrteafKernelEmbedGenerate.cmake -- DO NOT EDIT\n")
string(APPEND content "#include \"orteaf/internal/execution/cuda/platform/wrapper/cuda_kernel_embed_api.h\"\n")
string(APPEND content "#include \"orteaf/internal/execution/cuda/platform/wrapper/cuda_module.h\"\n")
string(APPEND content "#include \"orteaf/internal/diagnostics/error/error.h\"\n")
string(APPEND content "#include <array>\n")
string(APPEND content "#include <span>\n")
string(APPEND content "#include <string_view>\n")
string(APPEND content "#include <cstddef>\n\n")

set(declarations "")
set(entry_list)
string(REPLACE "|" ";" record_list "${KERNEL_RECORDS}")
set(declared_prefixes)

foreach(record ${record_list})
    if(record STREQUAL "")
        continue()
    endif()
    string(REPLACE ":" ";" parts "${record}")
    list(LENGTH parts part_count)
    if(part_count LESS 4)
        message(FATAL_ERROR "Invalid kernel record '${record}'")
    endif()
    list(GET parts 0 kernel_raw)
    list(GET parts 1 kernel_norm)
    list(GET parts 2 fmt)
    list(GET parts 3 prefix)

    list(FIND declared_prefixes "${prefix}" prefix_index)
    if(prefix_index EQUAL -1)
        string(APPEND declarations "extern const unsigned char ${prefix}_start[];\n")
        string(APPEND declarations "extern const unsigned char ${prefix}_end[];\n")
        list(APPEND declared_prefixes "${prefix}")
    endif()

    if(fmt STREQUAL "fatbin")
        set(fmt_enum "CudaKernelFmt::Fatbin")
    elseif(fmt STREQUAL "cubin")
        set(fmt_enum "CudaKernelFmt::Cubin")
    elseif(fmt STREQUAL "ptx")
        set(fmt_enum "CudaKernelFmt::Ptx")
    else()
        message(FATAL_ERROR "Unknown kernel format '${fmt}'")
    endif()

    list(APPEND entry_list "KernelEntry{\"${kernel_raw}\", ${fmt_enum}, ${prefix}_start, ${prefix}_end}")
endforeach()

string(APPEND content "${declarations}\n")
string(APPEND content "namespace orteaf::internal::execution::cuda::platform::wrapper::kernel_embed {\n\n")

list(LENGTH entry_list entry_count)
if(entry_count EQUAL 0)
    string(APPEND content "static constexpr std::array<KernelEntry, 0> entries = {};\n\n")
else()
    string(APPEND content "static constexpr std::array<KernelEntry, ${entry_count}> entries = {\n")
    foreach(line ${entry_list})
        string(APPEND content "    ${line},\n")
    endforeach()
    string(APPEND content "};\n\n")
endif()

string(APPEND content "static Blob make_blob(const KernelEntry& entry) {\n")
string(APPEND content "    return {entry.begin, static_cast<std::size_t>(entry.end - entry.begin)};\n")
string(APPEND content "}\n\n")

string(APPEND content "static Blob find_exact(std::string_view name, CudaKernelFmt fmt) {\n")
string(APPEND content "    for (const KernelEntry& entry : entries) {\n")
string(APPEND content "        if (std::string_view(entry.name) == name && entry.fmt == fmt) {\n")
string(APPEND content "            return make_blob(entry);\n")
string(APPEND content "        }\n")
string(APPEND content "    }\n")
string(APPEND content "    return {nullptr, 0};\n")
string(APPEND content "}\n\n")

string(APPEND content "std::span<const KernelEntry> kernels() { return entries; }\n\n")

string(APPEND content "static Blob try_format(std::string_view name, CudaKernelFmt fmt) {\n")
string(APPEND content "    switch (fmt) {\n")
string(APPEND content "    case CudaKernelFmt::Fatbin:\n")
string(APPEND content "#if ORTEAF_EMBED_HAS_FATBIN\n")
string(APPEND content "        return find_exact(name, CudaKernelFmt::Fatbin);\n")
string(APPEND content "#else\n")
string(APPEND content "        return {nullptr, 0};\n")
string(APPEND content "#endif\n")
string(APPEND content "    case CudaKernelFmt::Cubin:\n")
string(APPEND content "#if ORTEAF_EMBED_HAS_CUBIN\n")
string(APPEND content "        return find_exact(name, CudaKernelFmt::Cubin);\n")
string(APPEND content "#else\n")
string(APPEND content "        return {nullptr, 0};\n")
string(APPEND content "#endif\n")
string(APPEND content "    case CudaKernelFmt::Ptx:\n")
string(APPEND content "#if ORTEAF_EMBED_HAS_PTX\n")
string(APPEND content "        return find_exact(name, CudaKernelFmt::Ptx);\n")
string(APPEND content "#else\n")
string(APPEND content "        return {nullptr, 0};\n")
string(APPEND content "#endif\n")
string(APPEND content "    }\n")
string(APPEND content "    return {nullptr, 0};\n")
string(APPEND content "}\n\n")

string(APPEND content "Blob findKernelData(std::string_view name, CudaKernelFmt prefer) {\n")
string(APPEND content "    if (name.empty()) {\n")
string(APPEND content "        using namespace orteaf::internal::diagnostics::error;\n")
string(APPEND content "        throwError(OrteafErrc::InvalidParameter, \"findKernelData: name cannot be empty\");\n")
string(APPEND content "    }\n")
string(APPEND content "    Blob primary = try_format(name, prefer);\n")
string(APPEND content "    if (primary.data != nullptr && primary.size > 0) {\n")
string(APPEND content "        return primary;\n")
string(APPEND content "    }\n")
string(APPEND content "    constexpr CudaKernelFmt order[] = {CudaKernelFmt::Fatbin, CudaKernelFmt::Cubin, CudaKernelFmt::Ptx};\n")
string(APPEND content "    for (CudaKernelFmt fmt : order) {\n")
string(APPEND content "        if (fmt == prefer) continue;\n")
string(APPEND content "        Blob candidate = try_format(name, fmt);\n")
string(APPEND content "        if (candidate.data != nullptr && candidate.size > 0) {\n")
string(APPEND content "            return candidate;\n")
string(APPEND content "        }\n")
string(APPEND content "    }\n")
string(APPEND content "    return {nullptr, 0};\n")
string(APPEND content "}\n\n")

string(APPEND content "bool available(std::string_view name) {\n")
string(APPEND content "    if (name.empty()) {\n")
string(APPEND content "        using namespace orteaf::internal::diagnostics::error;\n")
string(APPEND content "        throwError(OrteafErrc::InvalidParameter, \"available: name cannot be empty\");\n")
string(APPEND content "    }\n")
string(APPEND content "    constexpr CudaKernelFmt order[] = {CudaKernelFmt::Fatbin, CudaKernelFmt::Cubin, CudaKernelFmt::Ptx};\n")
string(APPEND content "    for (CudaKernelFmt fmt : order) {\n")
string(APPEND content "        Blob blob = try_format(name, fmt);\n")
string(APPEND content "        if (blob.data != nullptr && blob.size > 0) {\n")
string(APPEND content "            return true;\n")
string(APPEND content "        }\n")
string(APPEND content "    }\n")
string(APPEND content "    return false;\n")
string(APPEND content "}\n\n")

string(APPEND content "CudaModule_t createEmbeddedModule(std::string_view name, CudaKernelFmt prefer) {\n")
string(APPEND content "    Blob blob = findKernelData(name, prefer);\n")
string(APPEND content "    if (blob.data == nullptr || blob.size == 0) {\n")
string(APPEND content "        return nullptr;\n")
string(APPEND content "    }\n")
string(APPEND content "    return ::orteaf::internal::execution::cuda::platform::wrapper::loadModuleFromImage(blob.data);\n")
string(APPEND content "}\n\n")

string(APPEND content "} // namespace orteaf::internal::execution::cuda::platform::wrapper::kernel_embed\n")

message(STATUS "OrteafKernelEmbedGenerate: writing ${OUTPUT}")
file(WRITE "${OUTPUT}" "${content}")
