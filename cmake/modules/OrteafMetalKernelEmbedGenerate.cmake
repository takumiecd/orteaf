# Generate Metal kernel registry entries header for ORTEAF.
# Required variables:
#   OUTPUT - destination header file
#   KERNEL_RECORDS - serialized list (kernel_name:symbol_prefix:obj_file)

if(NOT DEFINED OUTPUT)
    message(FATAL_ERROR "OrteafMetalKernelEmbedGenerate: OUTPUT not specified")
endif()
if(NOT DEFINED KERNEL_RECORDS)
    message(FATAL_ERROR "OrteafMetalKernelEmbedGenerate: KERNEL_RECORDS not specified")
endif()

get_filename_component(_gen_dir "${OUTPUT}" DIRECTORY)
if(NOT IS_DIRECTORY "${_gen_dir}")
    file(MAKE_DIRECTORY "${_gen_dir}")
endif()

set(content "// Auto-generated by OrteafMetalKernelEmbedGenerate.cmake -- DO NOT EDIT\n")
string(APPEND content "#pragma once\n\n")
string(APPEND content "#include \"orteaf/internal/execution/mps/platform/wrapper/metal_kernel_embed_api.h\"\n")
string(APPEND content "#include <array>\n\n")
string(APPEND content "namespace orteaf::internal::execution::mps::platform::metal_kernel_embed {\n\n")

set(declarations "extern \"C\" {\n")
set(entry_list)
string(REPLACE "|" ";" record_list "${KERNEL_RECORDS}")
set(declared_prefixes)

foreach(record ${record_list})
    if(record STREQUAL "")
        continue()
    endif()
    string(REPLACE ":" ";" parts "${record}")
    list(LENGTH parts part_count)
    if(part_count LESS 2)
        message(FATAL_ERROR "Invalid Metal kernel record '${record}'")
    endif()
    list(GET parts 0 kernel_name)
    list(GET parts 1 prefix)

    list(FIND declared_prefixes "${prefix}" prefix_index)
    if(prefix_index EQUAL -1)
        string(APPEND declarations "extern const unsigned char ${prefix}_start[];\n")
        string(APPEND declarations "extern const unsigned char ${prefix}_end[];\n")
        list(APPEND declared_prefixes "${prefix}")
    endif()

    list(APPEND entry_list "MetallibEntry{\"${kernel_name}\", ${prefix}_start, ${prefix}_end}")
endforeach()
string(APPEND declarations "}\n\n")
string(APPEND content "${declarations}")

list(LENGTH entry_list entry_count)
if(entry_count EQUAL 0)
    string(APPEND content "inline constexpr std::array<MetallibEntry, 0> kMetalKernelEntries = {};\n")
else()
    string(APPEND content "inline constexpr std::array<MetallibEntry, ${entry_count}> kMetalKernelEntries = {\n")
    foreach(line ${entry_list})
        string(APPEND content "    ${line},\n")
    endforeach()
    string(APPEND content "};\n")
endif()

string(APPEND content "\n} // namespace orteaf::internal::execution::mps::platform::metal_kernel_embed\n")

message(STATUS "OrteafMetalKernelEmbedGenerate: writing ${OUTPUT}")
file(WRITE "${OUTPUT}" "${content}")
if(NOT EXISTS "${OUTPUT}")
    message(FATAL_ERROR "Failed to create Metal kernel registry at ${OUTPUT}")
endif()
